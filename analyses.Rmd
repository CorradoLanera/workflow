---
title: "Target Markdown"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

Target Markdown is a powerful R Markdown interface for reproducible analysis pipelines, and the chapter at https://books.ropensci.org/targets/markdown.html walks through it in detail. 


# Setup

First, load `targets` to activate the specialized `knitr` engine for Target Markdown.

```{r}
library(targets)
```

Near the top, you may also wish to remove the `_targets_r` directory previously written by non-interactive runs of the report.

```{r}
tar_unscript()
```

# Globals

We first define some global options/functions common to all targets,
and load all our custom functions. 
```{targets example-globals, tar_globals = TRUE}
options(
  # tidyverse.quiet = TRUE
)

library(here)

tar_option_set(
  packages = c(NULL)
)

list.files(here("R"), pattern = "\\.R", full.names = TRUE) |> 
  lapply(source)
```

# Targets

Our first target borrows the `airquality` dataset built into base R.

```{targets airquality}
tar_target(airquality_loaded, airquality)
```

Our next targets preprocess the data, make a histogram, and fit a model.

```{targets our-data}
list(
  tar_target(raw_data_path,
             file.path(get_datapath(), "example_db.csv"),
             format = "file"),
  tar_target(example_db, read.csv(raw_data_path))
)
```

Set the `tar_simple` chunk option to `TRUE` to define a single target with the command in the code chunk. The chunk below only contains `ncol(example_db)` in the source, but because `tar_simple` is `TRUE`, it is shorthand for `tar_target(name = sum_of_col, command = ncol(example_db))`. All other arguments to `tar_target()` are set to their default values (configurable with `tar_option_set()`).

```{targets sum_of_col, tar_simple = TRUE}
colSums(example_db) * airquality_loaded
```

# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r}
tar_visnetwork()
tar_make()
```

# Output

You can retrieve results from the `_targets/` data store using `tar_read()` or `tar_load()`.

```{r, message = FALSE}
tar_read(example_db)
```

```{r}
tar_read(sum_of_col)
```

The `targets` dependency graph helps your readers understand the steps of your pipeline at a high level.

```{r}
tar_visnetwork()
```

At this point, you can go back and run `{targets}` chunks in interactive mode without interfering with the code or data of the non-interactive pipeline.
